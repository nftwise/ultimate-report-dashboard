'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
  TrendingUp,
  Users,
  DollarSign,
  Target,
  Phone,
  LogOut,
  ArrowUp,
  ArrowDown,
  Building2,
  AlertCircle,
  AlertTriangle,
  Search,
  Eye,
  MousePointer
} from 'lucide-react';
import { WeeklyReport } from '@/components/WeeklyReport';
import SixMonthLeadsChart from '@/components/SixMonthLeadsChart';
import { HeroWinSection } from '@/components/HeroWinSection';
import { LeadSourcesBreakdown } from '@/components/LeadSourcesBreakdown';
import { MonthInProgressCard } from '@/components/MonthInProgressCard';
import { AITrafficOnly } from '@/components/AITrafficOnly';

// KPI Card Component
function KPICard({ 
  title, 
  value, 
  change, 
  icon: Icon, 
  format = 'number',
  trend = 'neutral' 
}: any) {
  const isPositive = trend === 'up';
  const TrendIcon = isPositive ? ArrowUp : ArrowDown;
  
  return (
    <div className="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <p className="text-gray-600 text-sm font-medium mb-2">{title}</p>
          <p className="text-3xl font-bold text-gray-900">
            {format === 'currency' && '$'}
            {format === 'currency' ? value.toLocaleString('en-US', { minimumFractionDigits: 2 }) : value.toLocaleString()}
          </p>
          {change !== undefined && (
            <div className={`flex items-center gap-1 mt-2 text-sm ${
              isPositive ? 'text-green-600' : 'text-red-600'
            }`}>
              <TrendIcon className="w-3 h-3" />
              <span className="font-medium">{Math.abs(change)}%</span>
              <span className="text-gray-500">vs prev period</span>
            </div>
          )}
        </div>
        <div className={`p-3 rounded-lg ${
          isPositive ? 'bg-green-50' : 'bg-blue-50'
        }`}>
          <Icon className={`w-6 h-6 ${
            isPositive ? 'text-green-600' : 'text-blue-600'
          }`} />
        </div>
      </div>
    </div>
  );
}

// Modern Traffic Analytics Component
function ModernTrafficChart({ data }: { data: any[] }) {
  const [tooltip, setTooltip] = useState<{ show: boolean, x: number, y: number, value: number, date: string, users: number }>({
    show: false, x: 0, y: 0, value: 0, date: '', users: 0
  });
  const [selectedMetric] = useState('sessions');

  if (!data || data.length === 0) {
    return (
      <div className="bg-gradient-to-br from-blue-50 via-white to-indigo-50 rounded-2xl p-8 text-center">
        <div className="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
          <AlertCircle className="w-8 h-8 text-blue-500" />
        </div>
        <h3 className="text-lg font-semibold text-gray-800 mb-2">No Analytics Data</h3>
        <p className="text-gray-600">Connect your Google Analytics to see traffic insights</p>
      </div>
    );
  }

  const sessions = data.map(d => d.sessions || 0);
  const users = data.map(d => d.users || 0);
  const leads = data.map(d => d.leads || d.conversions || 0);
  
  const totalSessions = sessions.reduce((a, b) => a + b, 0);
  const totalUsers = users.reduce((a, b) => a + b, 0);
  const totalLeads = leads.reduce((a, b) => a + b, 0);
  
  const avgSessions = Math.round(totalSessions / sessions.length);
  const maxSessions = Math.max(...sessions);
  const maxUsers = Math.max(...users);
  const maxLeads = Math.max(...leads);
  

  // Format dates properly
  const formatDate = (dateStr: string) => {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } catch {
      return '';
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100">
      {/* Header */}
      <div className="px-6 py-5 border-b border-gray-100">
        <h2 className="text-lg font-semibold text-gray-900">Google Analytics Traffic</h2>
      </div>

      {/* Top KPIs - Simplified */}
      <div className="px-6 py-6">
        <div className="grid grid-cols-3 gap-8">
          <div className="text-center">
            <div className="text-xs text-gray-500 font-medium mb-1">Users</div>
            <div className="text-2xl font-bold text-gray-900">{totalUsers.toLocaleString()}</div>
            <div className="text-xs text-gray-400 mt-1">Unique visitors</div>
          </div>
          <div className="text-center">
            <div className="text-xs text-gray-500 font-medium mb-1">Sessions</div>
            <div className="text-2xl font-bold text-gray-900">{totalSessions.toLocaleString()}</div>
            <div className="text-xs text-gray-400 mt-1">Total visits</div>
          </div>
          <div className="text-center">
            <div className="text-xs text-gray-500 font-medium mb-1">Conversions</div>
            <div className="text-2xl font-bold text-green-600">{totalLeads}</div>
            <div className="text-xs text-gray-400 mt-1">Leads generated</div>
          </div>
        </div>
      </div>

      {/* Line Chart */}
      <div className="px-6 pb-8 border-t border-gray-50">
        <div className="pt-6">
          {/* Chart Container */}
          <div className="relative ml-12">
            <div className="relative h-80">
              <svg className="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                <defs>
                  <linearGradient id="gaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stopColor="#4285f4" stopOpacity="0.15"/>
                    <stop offset="100%" stopColor="#4285f4" stopOpacity="0.02"/>
                  </linearGradient>
                </defs>

                {/* Grid Lines */}
                {[20, 40, 60, 80].map(y => (
                  <line
                    key={y}
                    x1="0"
                    y1={y}
                    x2="100"
                    y2={y}
                    stroke="#f8f9fa"
                    strokeWidth="0.5"
                  />
                ))}

                {/* Area Fill */}
                <path
                  d={`M 0 90 ` + 
                    sessions.map((value, i) => {
                      const x = (i / Math.max(sessions.length - 1, 1)) * 100;
                      const y = 90 - ((value / Math.max(maxSessions * 1.1, 1)) * 75);
                      return `L ${x} ${y}`;
                    }).join(' ') + 
                    ` L 100 90 Z`}
                  fill="url(#gaGradient)"
                />

                {/* Smooth Line */}
                <path
                  fill="none"
                  stroke="#4285f4"
                  strokeWidth="0.5"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  d={(() => {
                    if (sessions.length === 0) return '';
                    
                    let path = '';
                    sessions.forEach((value, i) => {
                      const x = (i / Math.max(sessions.length - 1, 1)) * 100;
                      const y = 90 - ((value / Math.max(maxSessions * 1.1, 1)) * 75);
                      
                      if (i === 0) {
                        path += `M ${x} ${y}`;
                      } else {
                        path += ` L ${x} ${y}`;
                      }
                    });
                    
                    return path;
                  })()}
                />
              </svg>

              {/* Y-axis Labels */}
              <div className="absolute -left-12 top-0 h-full flex flex-col justify-between text-sm text-gray-600 w-10 font-bold">
                {(() => {
                  const max = Math.ceil(maxSessions / 100) * 100;
                  
                  return [max, Math.round(max * 0.75), Math.round(max * 0.5), Math.round(max * 0.25), 0].map((val, i) => (
                    <span key={i} className="text-right text-sm leading-none font-bold">
                      {val >= 1000 ? `${(val / 1000).toFixed(0)}k` : val}
                    </span>
                  ));
                })()}
              </div>

              {/* Interactive Overlay */}
              <div className="absolute inset-0 flex">
                {data.map((d, i) => (
                  <div
                    key={i}
                    className="flex-1 group relative cursor-pointer"
                    onMouseEnter={(e) => {
                      const rect = e.currentTarget.getBoundingClientRect();
                      setTooltip({
                        show: true,
                        x: rect.left + rect.width / 2,
                        y: rect.top - 20,
                        value: d.sessions || 0,
                        users: d.users || 0,
                        date: d.date
                      });
                    }}
                    onMouseLeave={() => setTooltip(prev => ({ ...prev, show: false }))}
                  >
                    <div className="w-full h-full relative">
                      <div className="absolute inset-y-0 left-1/2 w-px bg-gray-300 opacity-0 group-hover:opacity-50 transition-opacity" />
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* X-axis Labels */}
            <div className="flex justify-between mt-4 text-xs text-gray-400">
              {data.length > 0 && (() => {
                // Determine the appropriate interval and format based on data length
                let showEvery, dateFormat;
                
                if (data.length <= 7) {
                  // 7 days - show daily
                  showEvery = 1;
                  dateFormat = (date: string) => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  };
                } else if (data.length <= 30) {
                  // 30 days - show weekly (every 7 days)
                  showEvery = 7;
                  dateFormat = (date: string) => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  };
                } else {
                  // 90 days - show monthly
                  showEvery = Math.floor(data.length / 6);
                  dateFormat = (date: string) => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                  };
                }
                
                return data.filter((_, i) => i % showEvery === 0 || i === data.length - 1)
                  .filter(d => d.date && d.date !== '' && !isNaN(new Date(d.date).getTime()))
                  .map((d, i) => (
                    <span key={i} className="font-bold text-xs text-gray-600">
                      {dateFormat(d.date)}
                    </span>
                  ));
              })()}
            </div>
          </div>
        </div>
      </div>

      {/* Clean Tooltip */}
      {tooltip.show && (
        <div 
          className="fixed z-50 bg-white px-3 py-2 rounded-lg shadow-lg border border-gray-200 text-sm pointer-events-none"
          style={{
            left: tooltip.x - 70,
            top: tooltip.y - 65,
            transform: 'translateX(-50%)',
          }}
        >
          <div className="text-xs text-gray-500 mb-1">
            {tooltip.date && !isNaN(new Date(tooltip.date).getTime()) ? 
              new Date(tooltip.date).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                weekday: 'short'
              }) : 
              formatDate(tooltip.date)
            }
          </div>
          <div className="font-semibold text-gray-900">
            Sessions: {tooltip.value.toLocaleString()}
          </div>
        </div>
      )}
    </div>
  );
}

// Simplified Conversion Journey Component
function ConversionJourneySimple({ trafficData, callrailData, adsData }: { trafficData: any[], callrailData?: any, adsData?: any }) {
  if (!trafficData || trafficData.length === 0) {
    return (
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">The Conversion Journey</h3>
        <div className="text-center py-8 text-gray-500">
          No data available
        </div>
      </div>
    );
  }

  const totalUsers = trafficData.reduce((sum, day) => sum + (day.users || 0), 0);
  const totalSessions = trafficData.reduce((sum, day) => sum + (day.sessions || 0), 0);
  const totalConversions = trafficData.reduce((sum, day) => sum + (day.conversions || 0), 0);
  const adImpressions = adsData?.totalMetrics?.impressions || 0;
  const adClicks = adsData?.totalMetrics?.clicks || 0;

  // Simple journey: Impressions ‚Üí Clicks ‚Üí Visits ‚Üí Leads (REAL DATA ONLY)
  const journeySteps = [
    { label: 'People saw your ads', value: adImpressions, icon: 'üëÅÔ∏è' }, // Real impressions only
    { label: 'Clicked to visit', value: adClicks, icon: 'üñ±Ô∏è' }, // Real clicks only
    { label: 'Visited your website', value: totalUsers, icon: 'üåê' },
    { label: 'LEADS GENERATED', value: totalConversions, icon: 'üéØ', highlight: true },
  ];

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div className="mb-6">
        <h3 className="text-lg font-semibold text-gray-900">The Conversion Journey</h3>
        <p className="text-sm text-gray-500 mt-1">How visitors become leads</p>
      </div>

      <div className="space-y-6">
        {journeySteps.map((step, index) => (
          <div key={index}>
            <div className={`flex items-center gap-4 p-4 rounded-lg ${step.highlight ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-500' : 'bg-gray-50'}`}>
              <div className="text-3xl">{step.icon}</div>
              <div className="flex-1">
                <div className={`text-sm ${step.highlight ? 'text-green-900 font-semibold' : 'text-gray-600'}`}>
                  {step.label}
                </div>
                <div className={`text-2xl font-bold ${step.highlight ? 'text-green-600' : 'text-gray-900'}`}>
                  {step.value.toLocaleString()}
                </div>
              </div>
              {index > 0 && (
                <div className="text-sm text-gray-500">
                  {((step.value / journeySteps[index - 1].value) * 100).toFixed(1)}% conversion
                </div>
              )}
            </div>
            {index < journeySteps.length - 1 && (
              <div className="flex justify-center py-2">
                <div className="text-2xl text-gray-400">‚Üì</div>
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Insights */}
      <div className="mt-6 grid grid-cols-2 gap-4 pt-4 border-t border-gray-100">
        <div>
          <div className="text-xs text-gray-500 mb-1">‚úÖ Strong</div>
          <div className="text-sm text-gray-700">
            {adClicks > 0 && totalSessions > 0 && (adClicks / (adImpressions || 1)) > 0.03
              ? 'Your ad click rate is above average (4.1% vs industry 3.2%)'
              : 'Your website is converting visitors into leads effectively'}
          </div>
        </div>
        <div>
          <div className="text-xs text-gray-500 mb-1">‚ö†Ô∏è Opportunity</div>
          <div className="text-sm text-gray-700">
            {totalConversions > 0 && totalUsers > 0 && (totalConversions / totalUsers) < 0.05
              ? 'Improve conversion rate - test simplified contact forms'
              : 'Continue optimizing for even better performance'}
          </div>
        </div>
      </div>
    </div>
  );
}

// Real Traffic Sources Component (using actual Google Analytics data)
function RealTrafficSources({ trafficSourcesData }: { trafficSourcesData: any[] }) {
  // Group AI sources together - MOVED TO TOP
  const processTrafficSources = (sources: any[]) => {
    const aiSources = sources.filter(source => {
      const sourceLower = source.source?.toLowerCase() || '';
      const mediumLower = source.medium?.toLowerCase() || '';
      return sourceLower.includes('gemini') || sourceLower.includes('chatgpt') || 
             sourceLower.includes('claude') || sourceLower.includes('bard') ||
             sourceLower.includes('openai') || sourceLower.includes('copilot') ||
             sourceLower.includes('perplexity') || sourceLower.includes('you.com') ||
             (mediumLower.includes('referral') && (sourceLower.includes('ai') || sourceLower.includes('chat')));
    });

    const nonAiSources = sources.filter(source => {
      const sourceLower = source.source?.toLowerCase() || '';
      const mediumLower = source.medium?.toLowerCase() || '';
      return !(sourceLower.includes('gemini') || sourceLower.includes('chatgpt') || 
               sourceLower.includes('claude') || sourceLower.includes('bard') ||
               sourceLower.includes('openai') || sourceLower.includes('copilot') ||
               sourceLower.includes('perplexity') || sourceLower.includes('you.com') ||
               (mediumLower.includes('referral') && (sourceLower.includes('ai') || sourceLower.includes('chat'))));
    });

    const processedSources = [...nonAiSources];

    // Combine AI sources if any exist
    if (aiSources.length > 0) {
      const combinedAI = {
        source: 'AI Referral',
        medium: 'referral',
        sessions: aiSources.reduce((sum, source) => sum + (source.sessions || 0), 0),
        users: aiSources.reduce((sum, source) => sum + (source.users || 0), 0),
        conversions: aiSources.reduce((sum, source) => sum + (source.conversions || 0), 0),
      };
      processedSources.unshift(combinedAI);
    }

    return processedSources;
  };

  // Map sources to display icons and colors
  const getSourceDisplay = (source: string, medium: string) => {
    const sourceLower = source?.toLowerCase() || '';
    const mediumLower = medium?.toLowerCase() || '';
    
    // Check for AI sources first
    if (sourceLower.includes('gemini') || sourceLower.includes('chatgpt') || 
        sourceLower.includes('claude') || sourceLower.includes('bard') ||
        sourceLower.includes('openai') || sourceLower.includes('copilot') ||
        sourceLower.includes('perplexity') || sourceLower.includes('you.com') ||
        (mediumLower.includes('referral') && (sourceLower.includes('ai') || sourceLower.includes('chat')))) {
      return { icon: 'ü§ñ', color: 'bg-purple-600', name: 'AI Referral' };
    } else if (sourceLower.includes('google') && mediumLower.includes('organic')) {
      return { icon: 'üîç', color: 'bg-green-500', name: 'Google Organic' };
    } else if (sourceLower.includes('google') && mediumLower.includes('cpc')) {
      return { icon: 'üí∞', color: 'bg-blue-500', name: 'Google Ads' };
    } else if (sourceLower === 'direct' || sourceLower === '(direct)') {
      return { icon: 'üåê', color: 'bg-gray-600', name: 'Direct' };
    } else if (sourceLower.includes('facebook')) {
      return { icon: 'üìò', color: 'bg-blue-600', name: 'Facebook' };
    } else if (sourceLower.includes('linkedin')) {
      return { icon: 'üíº', color: 'bg-blue-700', name: 'LinkedIn' };
    } else if (sourceLower.includes('twitter') || sourceLower.includes('x.com')) {
      return { icon: 'üê¶', color: 'bg-black', name: 'Twitter/X' };
    } else if (sourceLower.includes('youtube')) {
      return { icon: 'üì∫', color: 'bg-red-500', name: 'YouTube' };
    } else if (sourceLower.includes('bing')) {
      return { icon: 'üîé', color: 'bg-cyan-500', name: 'Bing' };
    } else if (mediumLower.includes('referral')) {
      return { icon: 'üîó', color: 'bg-purple-500', name: source || 'Referral' };
    } else if (mediumLower.includes('email')) {
      return { icon: 'üìß', color: 'bg-orange-500', name: 'Email' };
    } else {
      return { icon: 'üåç', color: 'bg-gray-500', name: source || 'Unknown' };
    }
  };

  if (!trafficSourcesData || trafficSourcesData.length === 0) {
    return (
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-green-500 rounded-lg flex items-center justify-center">
            <span className="text-xl">üìä</span>
          </div>
          <h3 className="text-lg font-semibold text-gray-900">Traffic Sources</h3>
        </div>
        <div className="text-center py-8">
          <span className="text-red-500 font-medium">n/a - No traffic sources data available</span>
        </div>
      </div>
    );
  }

  // Process sources to combine AI traffic, then sort by sessions descending and take top 6
  const processedSources = processTrafficSources(trafficSourcesData);
  const topSources = processedSources
    .sort((a, b) => (b.sessions || 0) - (a.sessions || 0))
    .slice(0, 6);

  const totalSessions = topSources.reduce((sum, source) => sum + (source.sessions || 0), 0);

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-green-500 rounded-lg flex items-center justify-center">
            <span className="text-xl">üìä</span>
          </div>
          <div>
            <h3 className="text-lg font-semibold text-gray-900">Traffic Sources</h3>
            <p className="text-sm text-gray-500">{totalSessions.toLocaleString()} total sessions</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 bg-green-500 rounded-full"></div>
          <span className="text-xs text-green-600 font-medium">Live Data</span>
        </div>
      </div>

      <div className="space-y-3">
        {topSources.map((source, index) => {
          const display = getSourceDisplay(source.source, source.medium);
          const sessions = source.sessions || 0;
          const users = source.users || 0;
          const conversions = source.conversions || 0;
          const percentage = totalSessions > 0 ? ((sessions / totalSessions) * 100).toFixed(1) : '0.0';
          
          return (
            <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
              <div className="flex items-center gap-3">
                <div className={`w-8 h-8 ${display.color} rounded-full flex items-center justify-center text-white text-sm`}>
                  {display.icon}
                </div>
                <div>
                  <div className="font-medium text-gray-900">{display.name}</div>
                  <div className="text-xs text-gray-500">
                    {users ? `${users.toLocaleString()} users` : <span className="text-red-500">n/a users</span>}
                    {conversions ? ` ‚Ä¢ ${conversions} conversions` : ''}
                  </div>
                </div>
              </div>
              <div className="text-right">
                <div className="font-bold text-gray-900">
                  {sessions ? sessions.toLocaleString() : <span className="text-red-500 font-medium">n/a</span>}
                </div>
                <div className="text-xs text-blue-600 font-medium">{percentage}%</div>
              </div>
            </div>
          );
        })}
      </div>

      <div className="mt-6 grid grid-cols-3 gap-4 pt-4 border-t border-gray-100">
        <div className="text-center">
          <div className="text-xl font-bold text-blue-600">{topSources.length}</div>
          <div className="text-xs text-gray-500">Top Sources</div>
        </div>
        <div className="text-center">
          <div className="text-xl font-bold text-green-600">
            {topSources.reduce((sum, source) => sum + (source.users || 0), 0).toLocaleString()}
          </div>
          <div className="text-xs text-gray-500">Total Users</div>
        </div>
        <div className="text-center">
          <div className="text-xl font-bold text-purple-600">
            {topSources.reduce((sum, source) => sum + (source.conversions || 0), 0)}
          </div>
          <div className="text-xs text-gray-500">Conversions</div>
        </div>
      </div>
    </div>
  );
}

// Main Dashboard Component
export default function ProfessionalDashboard({ user }: { user: any }) {
  const [period, setPeriod] = useState('7days');
  const [activeView, setActiveView] = useState<'overview' | 'ads' | 'seo' | 'calls' | 'trends'>('overview'); // Sidebar view
  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [trafficData, setTrafficData] = useState<any[]>([]);
  const [topPagesData, setTopPagesData] = useState<any[]>([]);
  const [trafficSourcesData, setTrafficSourcesData] = useState<any[]>([]);
  const [recentCallsData, setRecentCallsData] = useState<any[]>([]);
  const [callsBySourceData, setCallsBySourceData] = useState<any[]>([]);
  const [searchConsoleData, setSearchConsoleData] = useState<any>({});
  const [searchConsoleQueries, setSearchConsoleQueries] = useState<any[]>([]);
  const [searchConsolePages, setSearchConsolePages] = useState<any[]>([]);
  const [apiErrors, setApiErrors] = useState<any>({});
  const router = useRouter();

  useEffect(() => {
    fetchDashboardData();
    fetchTrafficTrend();
    fetchTopPages();
    fetchTrafficSources();
    fetchRecentCalls();
    fetchCallsBySource();
    fetchSearchConsoleData();
    fetchSearchConsoleQueries();
    fetchSearchConsolePages();
    checkGoogleAdsAPI();
    checkCallRailAPI();
    checkSearchConsoleAPI();
  }, [period, user.id]);

  const fetchDashboardData = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/dashboard?period=${period}&clientId=${user.id}`);
      const result = await response.json();
      if (result.success) {
        setData(result.data);
      }
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchPreviousPeriodData = async () => {
    try {
      // Calculate previous period based on current selection
      const periodDays = period === '7days' ? 7 : period === '30days' ? 30 : 90;
      const today = new Date();

      // Previous period: go back (periodDays * 2) and fetch (periodDays) worth
      const previousEndDate = new Date(today);
      previousEndDate.setDate(previousEndDate.getDate() - periodDays);

      const previousStartDate = new Date(previousEndDate);
      previousStartDate.setDate(previousStartDate.getDate() - periodDays + 1);

      const formatDate = (date: Date) => date.toISOString().split('T')[0];

      // Fetch using custom date range
      const response = await fetch(
        `/api/dashboard?startDate=${formatDate(previousStartDate)}&endDate=${formatDate(previousEndDate)}&clientId=${user.id}&period=custom`
      );
      const result = await response.json();

      if (result.success) {
        setPreviousPeriodData(result.data);
        console.log('Previous period data loaded:', result.data);
      }
    } catch (error) {
      console.error('Failed to fetch previous period data:', error);
      setPreviousPeriodData(null);
    }
  };

  const generateTrafficData = () => {
    const data = [];
    const today = new Date();
    const periodDays = period === '7days' ? 7 : period === '30days' ? 30 : 90;
    
    for (let i = periodDays - 1; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      
      // Generate realistic session data
      const baseSessions = 140 + Math.floor(Math.random() * 80); // 140-220 sessions
      const weekendFactor = [0, 6].includes(date.getDay()) ? 0.75 : 1; // Lower weekend traffic
      const sessions = Math.floor(baseSessions * weekendFactor);
      
      data.push({
        date: formatDate(date.toISOString().split('T')[0]),
        sessions: sessions,
        users: 0, // Don't make up user data
        leads: 0, // Don't make up lead data
      });
    }
    
    return data;
  };

  const fetchTrafficTrend = async () => {
    try {
      // Get real Google Analytics daily data
      const response = await fetch(`/api/google-analytics?period=${period}&clientId=${user.id}&report=daily`);
      const result = await response.json();
      
      console.log('GA Daily API Response:', result);
      
      if (result.success && result.data) {
        // Check if we have daily data array (new format from getSessionsByDay)
        if (Array.isArray(result.data) && result.data.length > 0) {
          console.log('Found GA daily data array:', result.data);
          
          // Use actual daily data from Google Analytics
          const realDailyData = result.data
            .filter((day: any) => day.date && day.date !== '') // Filter out empty dates
            .map((day: any) => ({
              date: formatDate(day.date),
              sessions: day.sessions || 0,
              users: day.users || 0,
              conversions: day.conversions || 0,
              pageviews: day.pageviews || 0,
              leads: day.conversions || 0, // Use actual conversions as leads
            }))
            .sort((a: any, b: any) => {
              // Sort by original date format first
              return new Date(a.date.split('/').reverse().join('-')).getTime() - 
                     new Date(b.date.split('/').reverse().join('-')).getTime();
            });
            
          if (realDailyData.length > 0) {
            setTrafficData(realDailyData);
            setApiErrors((prev: any) => ({ ...prev, googleAnalytics: null }));
            console.log('‚úÖ Using REAL Google Analytics daily data:', realDailyData);
            return;
          }
        }
        
        // Check for old dimensions format (backward compatibility)
        if (result.data.dimensions && result.data.dimensions.length > 0) {
          console.log('Found GA dimensions data:', result.data.dimensions);
          
          const realDailyData = result.data.dimensions
            .filter((day: any) => day.date && day.date !== '')
            .map((day: any) => ({
              date: formatDate(day.date),
              sessions: parseInt(day.sessions) || 0,
              users: parseInt(day.users) || 0,
              leads: 0, // Don't calculate fake leads - use real conversion data
            }));
            
          if (realDailyData.length > 0) {
            setTrafficData(realDailyData);
            setApiErrors((prev: any) => ({ ...prev, googleAnalytics: null }));
            console.log('‚úÖ Using REAL GA dimensions data:', realDailyData);
            return;
          }
        }
        
        // If we have summary metrics but no daily breakdown, we cannot show daily chart
        if (result.data.metrics && result.data.metrics.sessions > 0) {
          const totalSessions = result.data.metrics.sessions;
          const totalUsers = result.data.metrics.users || 0; // Don't make up users

          console.log('GA summary data available but no daily breakdown - cannot show trend chart');

          // Don't create fake daily distributions - just show we have no daily data
          setTrafficData([]);
          setApiErrors((prev: any) => ({ ...prev, googleAnalytics: 'Daily breakdown not available - showing totals only' }));
          return;
        }
      }
      
      console.log('‚ùå No real GA data available, using mock data');
      // Fallback to mock data
      const mockData = generateTrafficData();
      setTrafficData(mockData);
      setApiErrors((prev: any) => ({ ...prev, googleAnalytics: 'Using mock data - no real GA data available' }));
      
    } catch (error) {
      console.error('‚ùå GA API Error:', error);
      // Fallback to mock data on error
      const mockData = generateTrafficData();
      setTrafficData(mockData);
      setApiErrors((prev: any) => ({ ...prev, googleAnalytics: 'Using mock data - API connection failed' }));
    }
  };

  const fetchTopPages = async () => {
    try {
      const response = await fetch(`/api/google-analytics?period=${period}&clientId=${user.id}&report=top-pages`);
      const result = await response.json();
      
      if (result.success && Array.isArray(result.data) && result.data.length > 0) {
        setTopPagesData(result.data);
        console.log('‚úÖ Loaded real top pages:', result.data);
      } else {
        setTopPagesData([]);
        console.log('‚ùå No top pages data available');
      }
    } catch (error) {
      console.error('Top pages API error:', error);
      setTopPagesData([]);
    }
  };

  const fetchTrafficSources = async () => {
    try {
      const response = await fetch(`/api/google-analytics?period=${period}&clientId=${user.id}&report=traffic-sources`);
      const result = await response.json();
      
      if (result.success && Array.isArray(result.data) && result.data.length > 0) {
        setTrafficSourcesData(result.data);
        console.log('‚úÖ Loaded real traffic sources:', result.data);
      } else {
        setTrafficSourcesData([]);
        console.log('‚ùå No traffic sources data available');
      }
    } catch (error) {
      console.error('Traffic sources API error:', error);
      setTrafficSourcesData([]);
    }
  };

  const fetchRecentCalls = async () => {
    try {
      const response = await fetch(`/api/callrail?period=${period}&clientId=${user.id}&report=recent-calls`);
      const result = await response.json();
      
      if (result.success && Array.isArray(result.data) && result.data.length > 0) {
        setRecentCallsData(result.data);
        console.log('‚úÖ Loaded recent calls:', result.data);
      } else {
        setRecentCallsData([]);
        console.log('‚ùå No recent calls data available');
      }
    } catch (error) {
      console.error('Recent calls API error:', error);
      setRecentCallsData([]);
    }
  };

  const fetchCallsBySource = async () => {
    try {
      const response = await fetch(`/api/callrail?period=${period}&clientId=${user.id}&report=by-source`);
      const result = await response.json();
      
      if (result.success && Array.isArray(result.data) && result.data.length > 0) {
        setCallsBySourceData(result.data);
        console.log('‚úÖ Loaded calls by source:', result.data);
      } else {
        setCallsBySourceData([]);
        console.log('‚ùå No calls by source data available');
      }
    } catch (error) {
      console.error('Calls by source API error:', error);
      setCallsBySourceData([]);
    }
  };

  const checkGoogleAdsAPI = async () => {
    try {
      const response = await fetch(`/api/google-ads?period=${period}&clientId=${user.id}&type=status`);
      const result = await response.json();
      
      if (!result.success) {
        setApiErrors((prev: any) => ({ ...prev, googleAds: result.error || 'Google Ads API connection failed' }));
      }
    } catch (error) {
      console.error('Failed to check Google Ads API:', error);
      setApiErrors((prev: any) => ({ ...prev, googleAds: 'Google Ads API connection failed' }));
    }
  };

  const checkCallRailAPI = async () => {
    try {
      const response = await fetch(`/api/callrail?period=${period}&clientId=${user.id}&type=status`);
      const result = await response.json();
      
      if (!result.success) {
        setApiErrors((prev: any) => ({ ...prev, callRail: result.error || 'CallRail API connection failed' }));
      }
    } catch (error) {
      console.error('Failed to check CallRail API:', error);
      setApiErrors((prev: any) => ({ ...prev, callRail: 'CallRail API connection failed' }));
    }
  };

  const fetchSearchConsoleData = async () => {
    try {
      console.log('üîç Fetching Search Console data...');
      const response = await fetch(`/api/search-console?period=${period}&clientId=${user.id}&type=performance`);
      const result = await response.json();

      console.log('Search Console API Response:', result);

      if (result.success && result.data) {
        setSearchConsoleData(result.data);
        setApiErrors((prev: any) => ({ ...prev, searchConsole: null }));
        console.log('‚úÖ Search Console data loaded successfully');
      } else {
        console.error('‚ùå Search Console API failed:', result.error);
        setApiErrors((prev: any) => ({ ...prev, searchConsole: result.error || 'Search Console API connection failed' }));
      }
    } catch (error) {
      console.error('‚ùå Search Console API Error:', error);
      setApiErrors((prev: any) => ({ ...prev, searchConsole: 'Search Console API connection failed' }));
    }
  };

  const fetchSearchConsoleQueries = async () => {
    try {
      const response = await fetch(`/api/search-console?period=${period}&clientId=${user.id}&type=queries`);
      const result = await response.json();

      if (result.success && result.data) {
        setSearchConsoleQueries(result.data.queries || []);
        console.log('‚úÖ Search Console queries loaded:', result.data.queries?.length || 0);
      }
    } catch (error) {
      console.error('Failed to fetch Search Console queries:', error);
      setSearchConsoleQueries([]);
    }
  };

  const fetchSearchConsolePages = async () => {
    try {
      const response = await fetch(`/api/search-console?period=${period}&clientId=${user.id}&type=pages`);
      const result = await response.json();

      if (result.success && result.data) {
        setSearchConsolePages(result.data.pages || []);
        console.log('‚úÖ Search Console pages loaded:', result.data.pages?.length || 0);
      }
    } catch (error) {
      console.error('Failed to fetch Search Console pages:', error);
      setSearchConsolePages([]);
    }
  };

  const checkSearchConsoleAPI = async () => {
    try {
      console.log('üîç Checking Search Console API status...');
      const response = await fetch(`/api/search-console?period=${period}&clientId=${user.id}&type=status`);
      const result = await response.json();

      if (!result.success) {
        console.error('‚ùå Search Console API check failed:', result.error);
        setApiErrors((prev: any) => ({ ...prev, searchConsole: result.error || 'Search Console API connection failed' }));
      } else {
        console.log('‚úÖ Search Console API check passed');
      }
    } catch (error) {
      console.error('Failed to check Search Console API:', error);
      setApiErrors((prev: any) => ({ ...prev, searchConsole: 'Search Console API connection failed' }));
    }
  };

  const formatDate = (dateStr: string) => {
    if (!dateStr) return '';
    
    try {
      // Handle different date formats (YYYY-MM-DD from GA4 API)
      let date;
      if (dateStr.includes('-')) {
        // GA4 format: "20250911" or "2025-09-11"
        if (dateStr.length === 8) {
          // Format: 20250911
          const year = dateStr.substring(0, 4);
          const month = dateStr.substring(4, 6);
          const day = dateStr.substring(6, 8);
          date = new Date(`${year}-${month}-${day}`);
        } else {
          // Format: 2025-09-11
          date = new Date(dateStr);
        }
      } else if (dateStr.length === 8) {
        // Format: 20250911
        const year = dateStr.substring(0, 4);
        const month = dateStr.substring(4, 6);
        const day = dateStr.substring(6, 8);
        date = new Date(`${year}-${month}-${day}`);
      } else {
        date = new Date(dateStr);
      }
      
      if (isNaN(date.getTime())) {
        console.warn('Invalid date:', dateStr);
        return '';
      }
      
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      return `${day}/${month}`;
    } catch (error) {
      console.error('Date formatting error:', error, 'for date:', dateStr);
      return '';
    }
  };

  const handleLogout = async () => {
    await fetch('/api/auth', { method: 'DELETE' });
    router.push('/login');
  };

  // Calculate KPIs with fallback for missing data
  // IMPORTANT: Leads should ONLY come from Google Ads conversions (not GA, not CallRail)
  const kpis = data ? {
    traffic: data.googleAnalytics?.metrics?.sessions || 0,
    leads: data.googleAds?.totalMetrics?.conversions || 0, // Only Google Ads conversions
    adSpend: data.googleAds?.totalMetrics?.cost || 0,
    cpl: (data.googleAds?.totalMetrics?.conversions || 0) > 0
      ? (data.googleAds?.totalMetrics?.cost || 0) / (data.googleAds?.totalMetrics?.conversions || 1)
      : 0,
    trafficChange: 0, // Will calculate from historical data
    leadsChange: 0,
    spendChange: 0,
    cplChange: 0,
  } : null;

  // Check if APIs are connected
  const hasGoogleAnalytics = trafficData && trafficData.length > 0;
  const hasGoogleAds = data?.googleAds?.totalMetrics?.impressions > 0;
  const hasCallRail = data?.callRail?.metrics?.totalCalls > 0;

  // Sidebar navigation items
  const navItems = [
    { id: 'overview' as const, label: 'Overview', icon: 'üìä', description: 'All channels summary' },
    { id: 'ads' as const, label: 'Google Ads', icon: 'üí∞', description: 'Paid advertising' },
    { id: 'seo' as const, label: 'SEO', icon: 'üîç', description: 'Organic search' },
    { id: 'calls' as const, label: 'Calls', icon: 'üìû', description: 'Phone tracking' },
    { id: 'trends' as const, label: 'Trends', icon: 'üìà', description: 'Historical data' },
  ];

  return (
    <div className="min-h-screen bg-gray-50 flex">
      {/* Sidebar Navigation */}
      <aside className="w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full">
        {/* Logo/Brand */}
        <div className="p-6 border-b border-gray-200">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
              <Building2 className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-sm font-semibold text-gray-900">{user.companyName}</h1>
              <p className="text-xs text-gray-500">Dashboard</p>
            </div>
          </div>
        </div>

        {/* Navigation Items */}
        <nav className="flex-1 p-4">
          <div className="space-y-1">
            {navItems.map((item) => (
              <button
                key={item.id}
                onClick={() => setActiveView(item.id)}
                className={`
                  w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-all
                  ${activeView === item.id
                    ? 'bg-blue-50 text-blue-700 font-medium shadow-sm'
                    : 'text-gray-700 hover:bg-gray-50'
                  }
                `}
              >
                <span className="text-xl">{item.icon}</span>
                <div className="flex-1">
                  <div className="text-sm font-medium">{item.label}</div>
                  <div className="text-xs text-gray-500">{item.description}</div>
                </div>
                {activeView === item.id && (
                  <span className="text-blue-600">‚ñ∫</span>
                )}
              </button>
            ))}
          </div>
        </nav>

        {/* Bottom Settings */}
        <div className="p-4 border-t border-gray-200">
          <button
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-gray-700 hover:bg-gray-50 transition-all"
          >
            <LogOut className="w-5 h-5" />
            <span className="text-sm font-medium">Logout</span>
          </button>
        </div>
      </aside>

      {/* Main Content Area */}
      <div className="flex-1 ml-64">
        {/* Top Navigation Bar */}
        <header className="bg-white shadow-sm border-b sticky top-0 z-10">
          <div className="px-6 py-4">
            <div className="flex items-center justify-between">
              {/* Breadcrumb / View Title */}
              <div>
                <h2 className="text-lg font-semibold text-gray-900 capitalize">{activeView}</h2>
                <p className="text-xs text-gray-500">
                  {navItems.find(item => item.id === activeView)?.description}
                </p>
              </div>

              {/* Controls */}
              <div className="flex items-center gap-4">
                {/* Date Range Selector */}
                <select
                  value={period}
                  onChange={(e) => setPeriod(e.target.value)}
                  className="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="7days">Last 7 days</option>
                  <option value="30days">Last 30 days</option>
                  <option value="90days">Last 90 days</option>
              </select>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="px-6 py-8">
        <div className="max-w-7xl mx-auto space-y-6">

          {/* OVERVIEW VIEW */}
          {activeView === 'overview' && (
            <>

          {/* SECTION 1: HERO WIN - Dynamic based on best metric
              Note: Growth percentages and previous period data are 0 until we implement
              real historical comparison API calls. Currently showing current period stats only.
          */}
          <HeroWinSection
            leadsGrowth={0} // No fake growth data
            costPerLeadChange={0} // No fake change data
            trafficGrowth={0} // No fake growth data
            currentLeads={kpis?.leads || 0}
            previousLeads={0} // Don't calculate fake previous period
            currentCostPerLead={kpis?.cpl || 0}
            previousCostPerLead={0} // Don't calculate fake previous period
            currentTraffic={kpis?.traffic || 0}
            topKeywordsImproved={searchConsoleQueries?.filter((q: any) => q.position < 10).length || 0}
          />

          {/* SECTION 1: BUSINESS SUMMARY - Top KPIs */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
            <div className="mb-6">
              <h2 className="text-xl font-bold text-gray-900">Business Summary</h2>
              <p className="text-sm text-gray-500 mt-1">Your most important numbers</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <KPICard
                title="Total Leads"
                value={kpis?.leads || 0}
                change={kpis?.leadsChange}
                icon={Target}
                trend="up"
              />
              <KPICard
                title="Total Calls"
                value={data?.callRail?.metrics?.totalCalls || 0}
                icon={Phone}
                trend="up"
              />
              <KPICard
                title="Total Ad Spend"
                value={kpis?.adSpend || 0}
                change={kpis?.spendChange}
                icon={DollarSign}
                format="currency"
                trend="down"
              />
              <KPICard
                title="Cost Per Lead"
                value={kpis?.cpl || 0}
                change={kpis?.cplChange}
                icon={TrendingUp}
                format="currency"
                trend="down"
              />
            </div>
          </div>

          {/* SECTION 2: CHANNEL PERFORMANCE COMPARISON */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
            <div className="mb-6">
              <h2 className="text-xl font-bold text-gray-900">Channel Performance</h2>
              <p className="text-sm text-gray-500 mt-1">Compare how each marketing channel is performing</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {/* Google Ads Card */}
              <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-blue-900">Google Ads</h3>
                  <span className="text-2xl">üì¢</span>
                </div>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-blue-700">Leads:</span>
                    <span className="text-lg font-bold text-blue-900">{kpis?.leads || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-blue-700">Clicks:</span>
                    <span className="text-lg font-bold text-blue-900">{(data?.googleAds?.totalMetrics?.clicks || 0).toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-blue-700">Impressions:</span>
                    <span className="text-lg font-bold text-blue-900">{(data?.googleAds?.totalMetrics?.impressions || 0).toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t border-blue-300">
                    <span className="text-sm text-blue-700">CPL:</span>
                    <span className="text-lg font-bold text-blue-900">${(kpis?.cpl || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>

              {/* SEO/Organic Card */}
              <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border-2 border-green-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-green-900">SEO/Organic</h3>
                  <span className="text-2xl">üîç</span>
                </div>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-green-700">Sessions:</span>
                    <span className="text-lg font-bold text-green-900">{kpis?.traffic || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-green-700">Form Fills:</span>
                    <span className="text-lg font-bold text-green-900">{data?.gaEvents?.formSubmissions || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-green-700">Web Calls:</span>
                    <span className="text-lg font-bold text-green-900">{data?.gaEvents?.phoneCalls || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-green-700">Click to Chat:</span>
                    <span className="text-lg font-bold text-green-900">{data?.gaEvents?.clickToChat || 0}</span>
                  </div>
                </div>
              </div>

              {/* CallRail Card */}
              <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border-2 border-purple-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-purple-900">CallRail</h3>
                  <span className="text-2xl">üìû</span>
                </div>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-purple-700">Total Calls:</span>
                    <span className="text-lg font-bold text-purple-900">{data?.callRail?.metrics?.totalCalls || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-purple-700">Answered:</span>
                    <span className="text-lg font-bold text-green-700">{data?.callRail?.metrics?.answeredCalls || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-purple-700">Missed:</span>
                    <span className="text-lg font-bold text-red-700">{data?.callRail?.metrics?.missedCalls || 0}</span>
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t border-purple-300">
                    <span className="text-sm text-purple-700">Avg Duration:</span>
                    <span className="text-lg font-bold text-purple-900">{Math.round(data?.callRail?.metrics?.averageDuration || 0)}s</span>
                  </div>
                </div>
              </div>

              {/* Search Console Card */}
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border-2 border-orange-200">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-orange-900">Search Console</h3>
                  <span className="text-2xl">üìä</span>
                </div>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-orange-700">Impressions:</span>
                    <span className="text-lg font-bold text-orange-900">{(searchConsoleData?.totals?.impressions || 0).toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-orange-700">Keywords:</span>
                    <span className="text-lg font-bold text-orange-900">{searchConsoleQueries?.length || 0}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-orange-700">Clicks:</span>
                    <span className="text-lg font-bold text-orange-900">{(searchConsoleData?.totals?.clicks || 0).toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t border-orange-300">
                    <span className="text-sm text-orange-700">Avg CTR:</span>
                    <span className="text-lg font-bold text-orange-900">{((searchConsoleData?.totals?.avgCtr || 0) * 100).toFixed(1)}%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* SECTION 3: TRAFFIC ANALYSIS */}
          {/* 6-Month Lead Generation Trend */}
          <SixMonthLeadsChart clientId={user.id} />

          {/* Traffic Sources */}
          <RealTrafficSources trafficSourcesData={trafficSourcesData} />

          {/* AI Referral Traffic */}
          <AITrafficOnly trafficSourcesData={trafficSourcesData} />

          {/* End of Overview */}
            </>
          )}
          {/* END OVERVIEW VIEW */}

          {/* END OVERVIEW VIEW */}

          {/* GOOGLE ADS VIEW */}
          {activeView === 'ads' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-8 text-white">
                <h2 className="text-2xl font-bold mb-2">üí∞ Google Ads Performance</h2>
                <p className="text-blue-100">Deep dive into your paid advertising campaigns</p>
              </div>

              {/* KPIs for Ads */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Conversions</div>
                  <div className="text-3xl font-bold text-gray-900">{kpis?.leads || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">Total leads from ads</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Ad Spend</div>
                  <div className="text-3xl font-bold text-gray-900">${(kpis?.adSpend || 0).toFixed(2)}</div>
                  <div className="text-xs text-gray-500 mt-1">Total investment</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Cost Per Lead</div>
                  <div className="text-3xl font-bold text-gray-900">${(kpis?.cpl || 0).toFixed(2)}</div>
                  <div className="text-xs text-gray-500 mt-1">Average CPL</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Click Rate</div>
                  <div className="text-3xl font-bold text-gray-900">{(data?.googleAds?.totalMetrics?.ctr || 0).toFixed(2)}%</div>
                  <div className="text-xs text-gray-500 mt-1">CTR</div>
                </div>
              </div>

              {/* Period Comparison for Ads */}
              {previousPeriodData && (
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <h3 className="text-lg font-semibold mb-4">Period Comparison</h3>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Leads</div>
                      <div className="text-2xl font-bold">{kpis?.leads || 0}</div>
                      <div className="text-xs text-gray-500">vs {previousPeriodData.googleAds?.totalMetrics?.conversions || 0}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Spend</div>
                      <div className="text-2xl font-bold">${(kpis?.adSpend || 0).toFixed(2)}</div>
                      <div className="text-xs text-gray-500">vs ${(previousPeriodData.googleAds?.totalMetrics?.cost || 0).toFixed(2)}</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">CPL</div>
                      <div className="text-2xl font-bold">${(kpis?.cpl || 0).toFixed(2)}</div>
                      <div className="text-xs text-gray-500">vs ${previousPeriodData.googleAds?.totalMetrics?.conversions > 0 ? (previousPeriodData.googleAds.totalMetrics.cost / previousPeriodData.googleAds.totalMetrics.conversions).toFixed(2) : '0.00'}</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Campaigns Table */}
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="px-6 py-4 border-b">
                  <h3 className="text-lg font-semibold">Campaign Performance</h3>
                </div>
                {data?.googleAds?.campaigns && data.googleAds.campaigns.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500">Campaign</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500">Status</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Impressions</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Clicks</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">CTR</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Cost</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Conversions</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">CPL</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {data.googleAds.campaigns.map((campaign: any, index: number) => (
                          <tr key={index} className="hover:bg-gray-50">
                            <td className="px-6 py-4 text-sm font-medium text-gray-900">{campaign.name}</td>
                            <td className="px-6 py-4 text-sm">
                              <span className={`px-2 py-1 rounded-full text-xs ${
                                campaign.status === 'ENABLED' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                              }`}>
                                {campaign.status}
                              </span>
                            </td>
                            <td className="px-6 py-4 text-sm text-right">{campaign.metrics.impressions.toLocaleString()}</td>
                            <td className="px-6 py-4 text-sm text-right">{campaign.metrics.clicks.toLocaleString()}</td>
                            <td className="px-6 py-4 text-sm text-right">{campaign.metrics.ctr.toFixed(2)}%</td>
                            <td className="px-6 py-4 text-sm text-right">${campaign.metrics.cost.toFixed(2)}</td>
                            <td className="px-6 py-4 text-sm text-right font-semibold">{campaign.metrics.conversions.toFixed(0)}</td>
                            <td className="px-6 py-4 text-sm text-right">${campaign.metrics.costPerConversion.toFixed(2)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">No campaign data available</div>
                )}
              </div>

              {/* Conversion Journey - Ads Focus */}
              <div className="bg-white rounded-xl p-6 shadow-sm border">
                <h3 className="text-lg font-semibold mb-4">Conversion Journey</h3>
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">üëÅÔ∏è</div>
                      <div>
                        <div className="font-medium">Impressions</div>
                        <div className="text-sm text-gray-500">People saw your ads</div>
                      </div>
                    </div>
                    <div className="text-2xl font-bold">{(data?.googleAds?.totalMetrics?.impressions || 0).toLocaleString()}</div>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl">üñ±Ô∏è</div>
                      <div>
                        <div className="font-medium">Clicks</div>
                        <div className="text-sm text-gray-500">Clicked to visit</div>
                      </div>
                    </div>
                    <div className="text-2xl font-bold">{(data?.googleAds?.totalMetrics?.clicks || 0).toLocaleString()}</div>
                  </div>
                  <div className="flex items-center justify-between p-4 bg-green-50 rounded-lg border-2 border-green-200">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-200 rounded-full flex items-center justify-center text-xl">üéØ</div>
                      <div>
                        <div className="font-medium text-green-900">Conversions</div>
                        <div className="text-sm text-green-700">Became leads</div>
                      </div>
                    </div>
                    <div className="text-2xl font-bold text-green-900">{kpis?.leads || 0}</div>
                  </div>
                </div>
              </div>
            </div>
          )}
          {/* END GOOGLE ADS VIEW */}

          {/* SEO VIEW */}
          {activeView === 'seo' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-8 text-white">
                <h2 className="text-2xl font-bold mb-2">üîç SEO Performance</h2>
                <p className="text-green-100">Organic search traffic and rankings</p>
              </div>

              {/* SEO KPIs */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Organic Traffic</div>
                  <div className="text-3xl font-bold text-gray-900">{kpis?.traffic || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">Total sessions</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Impressions</div>
                  <div className="text-3xl font-bold text-gray-900">{(searchConsoleData?.totals?.impressions || 0).toLocaleString()}</div>
                  <div className="text-xs text-gray-500 mt-1">In search results</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Clicks</div>
                  <div className="text-3xl font-bold text-gray-900">{(searchConsoleData?.totals?.clicks || 0).toLocaleString()}</div>
                  <div className="text-xs text-gray-500 mt-1">From search</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">CTR</div>
                  <div className="text-3xl font-bold text-gray-900">{((searchConsoleData?.totals?.avgCtr || 0) * 100).toFixed(1)}%</div>
                  <div className="text-xs text-gray-500 mt-1">Click-through rate</div>
                </div>
              </div>

              {/* Traffic Chart */}
              <div className="bg-white rounded-xl shadow-sm border p-6">
                <h3 className="text-lg font-semibold mb-4">Traffic Trend</h3>
                <ModernTrafficChart data={trafficData} />
              </div>

              {/* Top Keywords */}
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="px-6 py-4 border-b">
                  <h3 className="text-lg font-semibold">Top Ranking Keywords</h3>
                </div>
                {searchConsoleQueries && searchConsoleQueries.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500">Keyword</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Position</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Impressions</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">Clicks</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500">CTR</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {searchConsoleQueries.slice(0, 15).map((query: any, index: number) => (
                          <tr key={index} className="hover:bg-gray-50">
                            <td className="px-6 py-4 text-sm font-medium text-gray-900">{query.query}</td>
                            <td className="px-6 py-4 text-sm text-right">
                              <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                                (query.position || 0) <= 3 ? 'bg-green-100 text-green-800' :
                                (query.position || 0) <= 10 ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                              }`}>
                                #{(query.position || 0).toFixed(0)}
                              </span>
                            </td>
                            <td className="px-6 py-4 text-sm text-right">{(query.impressions || 0).toLocaleString()}</td>
                            <td className="px-6 py-4 text-sm text-right font-semibold">{(query.clicks || 0).toLocaleString()}</td>
                            <td className="px-6 py-4 text-sm text-right">{((query.ctr || 0) * 100).toFixed(1)}%</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">No keyword data available</div>
                )}
              </div>

              {/* Top Pages */}
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="px-6 py-4 border-b">
                  <h3 className="text-lg font-semibold">Top Landing Pages</h3>
                </div>
                {topPagesData && topPagesData.length > 0 ? (
                  <div className="divide-y divide-gray-200">
                    {topPagesData.slice(0, 10).map((page: any, index: number) => (
                      <div key={index} className="p-4 hover:bg-gray-50">
                        <div className="flex items-center justify-between">
                          <div className="flex-1">
                            <div className="font-medium text-gray-900">{page.path}</div>
                            <div className="text-sm text-gray-500">{(page.views || 0).toLocaleString()} views</div>
                          </div>
                          <div className="text-right">
                            <div className="text-lg font-bold text-blue-600">{(page.views || 0).toLocaleString()}</div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">No page data available</div>
                )}
              </div>
            </div>
          )}
          {/* END SEO VIEW */}

          {/* CALLS VIEW */}
          {activeView === 'calls' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl p-8 text-white">
                <h2 className="text-2xl font-bold mb-2">üìû Call Tracking</h2>
                <p className="text-purple-100">Phone leads and call analytics</p>
              </div>

              {/* Call KPIs */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Total Calls</div>
                  <div className="text-3xl font-bold text-gray-900">{data?.callRail?.metrics?.totalCalls || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">All calls received</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Answered</div>
                  <div className="text-3xl font-bold text-green-600">{data?.callRail?.metrics?.answeredCalls || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">Calls answered</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Missed</div>
                  <div className="text-3xl font-bold text-red-600">{data?.callRail?.metrics?.missedCalls || 0}</div>
                  <div className="text-xs text-gray-500 mt-1">Calls missed</div>
                </div>
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <div className="text-sm text-gray-500 mb-2">Avg Duration</div>
                  <div className="text-3xl font-bold text-gray-900">{Math.round((data?.callRail?.metrics?.averageDuration || 0) / 60)}m</div>
                  <div className="text-xs text-gray-500 mt-1">Minutes per call</div>
                </div>
              </div>

              {/* Recent Calls */}
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="px-6 py-4 border-b">
                  <h3 className="text-lg font-semibold">Recent Calls</h3>
                </div>
                {recentCallsData && recentCallsData.length > 0 ? (
                  <div className="divide-y divide-gray-200">
                    {recentCallsData.map((call: any, index: number) => (
                      <div key={index} className="p-4 hover:bg-gray-50">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-4">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                              call.answered ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                            }`}>
                              <Phone className="w-5 h-5" />
                            </div>
                            <div>
                              <div className="font-medium text-gray-900">{call.caller || 'Unknown'}</div>
                              <div className="text-sm text-gray-500">
                                {call.source || 'Direct'} ‚Ä¢ {call.duration || '0'}s ‚Ä¢ {call.timestamp || 'Recently'}
                              </div>
                            </div>
                          </div>
                          <div>
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                              call.answered ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }`}>
                              {call.answered ? 'Answered' : 'Missed'}
                            </span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">No call data available</div>
                )}
              </div>

              {/* Calls by Source */}
              <div className="bg-white rounded-xl shadow-sm border">
                <div className="px-6 py-4 border-b">
                  <h3 className="text-lg font-semibold">Calls by Source</h3>
                </div>
                {callsBySourceData && callsBySourceData.length > 0 ? (
                  <div className="p-6 space-y-4">
                    {callsBySourceData.map((source: any, index: number) => (
                      <div key={index} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div>
                          <div className="font-medium text-gray-900">{source.source || 'Unknown'}</div>
                          <div className="text-sm text-gray-500">{source.calls || 0} calls</div>
                        </div>
                        <div className="text-2xl font-bold text-blue-600">{source.calls || 0}</div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">No source data available</div>
                )}
              </div>
            </div>
          )}
          {/* END CALLS VIEW */}

          {/* TRENDS VIEW */}
          {activeView === 'trends' && (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-orange-500 to-red-600 rounded-xl p-8 text-white">
                <h2 className="text-2xl font-bold mb-2">üìà Historical Trends</h2>
                <p className="text-orange-100">Long-term performance analysis</p>
              </div>

              {/* 6-Month Trend */}
              <SixMonthLeadsChart clientId={user.id} />

              {/* Period Comparison - Detailed */}
              {previousPeriodData && kpis && (
                <div className="bg-white rounded-xl shadow-sm border p-6">
                  <h3 className="text-lg font-semibold mb-6">Period-over-Period Analysis</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="text-center p-6 bg-blue-50 rounded-lg">
                      <div className="text-4xl font-bold text-blue-600">{kpis.leads || 0}</div>
                      <div className="text-sm text-gray-600 mt-2">Current Period Leads</div>
                      <div className="text-xs text-gray-500 mt-1">
                        vs {previousPeriodData.googleAds?.totalMetrics?.conversions || 0} previous
                      </div>
                    </div>
                    <div className="text-center p-6 bg-green-50 rounded-lg">
                      <div className="text-4xl font-bold text-green-600">${(kpis.adSpend || 0).toFixed(0)}</div>
                      <div className="text-sm text-gray-600 mt-2">Current Period Spend</div>
                      <div className="text-xs text-gray-500 mt-1">
                        vs ${(previousPeriodData.googleAds?.totalMetrics?.cost || 0).toFixed(0)} previous
                      </div>
                    </div>
                    <div className="text-center p-6 bg-purple-50 rounded-lg">
                      <div className="text-4xl font-bold text-purple-600">${(kpis.cpl || 0).toFixed(2)}</div>
                      <div className="text-sm text-gray-600 mt-2">Current CPL</div>
                      <div className="text-xs text-gray-500 mt-1">
                        vs ${previousPeriodData.googleAds?.totalMetrics?.conversions > 0 ? (previousPeriodData.googleAds.totalMetrics.cost / previousPeriodData.googleAds.totalMetrics.conversions).toFixed(2) : '0.00'} previous
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Traffic Trend */}
              <div className="bg-white rounded-xl shadow-sm border p-6">
                <h3 className="text-lg font-semibold mb-4">Traffic Trend ({period})</h3>
                <ModernTrafficChart data={trafficData} />
              </div>

              {/* Summary Stats */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <h4 className="font-semibold mb-4">Performance Summary</h4>
                  <div className="space-y-3">
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Total Leads</span>
                      <span className="font-bold text-lg">{kpis?.leads || 0}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Total Spend</span>
                      <span className="font-bold text-lg">${(kpis?.adSpend || 0).toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Avg CPL</span>
                      <span className="font-bold text-lg">${(kpis?.cpl || 0).toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-gray-600">Total Traffic</span>
                      <span className="font-bold text-lg">{(kpis?.traffic || 0).toLocaleString()}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl p-6 shadow-sm border">
                  <h4 className="font-semibold mb-4">Key Insights</h4>
                  <div className="space-y-3 text-sm text-gray-600">
                    <div className="flex items-start gap-2">
                      <span className="text-green-600">‚úì</span>
                      <span>Tracking {period === '7days' ? '7' : period === '30days' ? '30' : '90'} days of performance data</span>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="text-blue-600">‚ÑπÔ∏è</span>
                      <span>Compare periods using the selector above</span>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="text-purple-600">üìä</span>
                      <span>All data pulled from live Google Ads & Analytics APIs</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          {/* END TRENDS VIEW */}

        </div>
      </main>
      </div>
    </div>
  );
}